<!doctype html>
<head>
	<title>LOD Lorries</title>
	<script src="../dist/threebox.js" type="text/javascript"></script>
	<link href="./css/threebox.css" rel="stylesheet" />
	<script src="config.js"></script>
	<script src="https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js"></script>
	<link href="https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css" rel="stylesheet" />
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<style>
		body, html {
			width: 100%;
			height: 100%;
			margin: 0;
			background: black;
		}

		#map {
			width: 100%;
			height: 100%;
		}

		#explainer {
			z-index: 99;
		}
	</style>
</head>
<body>
	<div id='map' class='map'></div>
	<script>

		// This example downloads a truck model from an external OBJ/MTL file, adds it to the map, and drives it around via paths fetched from the Mapbox Directions API

		if (!config) console.error("Config not set! Make a copy of 'config_template.js', add in your access token, and save the file as 'config.js'.");

		mapboxgl.accessToken = config.accessToken;

        var THREE;
        
        // Todo: remove not used vars

		var origin = [-122.4340, 37.7353];

		var destination, line;
		var y_block, g_block, ran_g, ran_y;

		var lorry_a, lorry_b;

		var map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/mapbox/dark-v9',
			center: origin,
			zoom: 20,
			pitch: 60,
			bearing: 90,
			hash: true
		});

		map.on('style.load', function () {

			map
				.addLayer({
					id: 'custom_layer',
					type: 'custom',
					renderingMode: '3d',
					onAdd: function (map, mbxContext) {

						window.tb = new Threebox(
							map,
							mbxContext,
							{ defaultLights: true }
						);

						loadModelExternal();

					},

					render: function (gl, matrix) {
						tb.update();
					}
				});
		})

        //Todo: add comments

		function createLevelsArray(models) {

			model_a = models[0];
			model_b = models[1];

			let new_model =  tb.Object3D({obj: model_a});
			const new_model_b = tb.Object3D({obj: model_b});
			new_model.setCoords(origin);

			
			tb.initLOD(new_model, 18);
			tb.addLODLevel(new_model, 19, new_model_b);

			console.log('model_to_add', new_model);
			tb.add(new_model);
        }

        //Todo: refactor
		function loadModelExternal() {
			const loader = new THREE.GLTFLoader();
			loader.load('models/lorry_1.glb', (model) => {lorry_a = model.scene; if (lorry_a && lorry_b){createLevelsArray([lorry_a, lorry_b])}}, () => {}, (err) => {console.error(err)});
			loader.load('models/lorry_2.glb', (model) => {lorry_b = model.scene; if (lorry_a && lorry_b){createLevelsArray([lorry_a, lorry_b])}}, () => {}, (err) => {console.error(err)});
		}

	</script>
</body>